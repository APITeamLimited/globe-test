// Copyright 2015 Red Hat Inc. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

package doc

import (
	"bytes"
	"fmt"
	"io"
	"os"
	"path/filepath"
	"sort"
	"strings"
	"time"

	"github.com/cpuguy83/go-md2man/md2man"
	"github.com/spf13/cobra"
	"github.com/spf13/pflag"
)

// GenManTree will generate a man page for this command and all descendants
// in the directory given. The header may be nil. This function may not work
// correctly if your command names have `-` in them. If you have `cmd` with two
// subcmds, `sub` and `sub-third`, and `sub` has a subcommand called `third`
// it is undefined which help output will be in the file `cmd-sub-third.1`.
func GenManTree(cmd *cobra.Command, header *GenManHeader, dir string) error ***REMOVED***
	return GenManTreeFromOpts(cmd, GenManTreeOptions***REMOVED***
		Header:           header,
		Path:             dir,
		CommandSeparator: "-",
	***REMOVED***)
***REMOVED***

// GenManTreeFromOpts generates a man page for the command and all descendants.
// The pages are written to the opts.Path directory.
func GenManTreeFromOpts(cmd *cobra.Command, opts GenManTreeOptions) error ***REMOVED***
	header := opts.Header
	if header == nil ***REMOVED***
		header = &GenManHeader***REMOVED******REMOVED***
	***REMOVED***
	for _, c := range cmd.Commands() ***REMOVED***
		if !c.IsAvailableCommand() || c.IsAdditionalHelpTopicCommand() ***REMOVED***
			continue
		***REMOVED***
		if err := GenManTreeFromOpts(c, opts); err != nil ***REMOVED***
			return err
		***REMOVED***
	***REMOVED***
	section := "1"
	if header.Section != "" ***REMOVED***
		section = header.Section
	***REMOVED***

	separator := "_"
	if opts.CommandSeparator != "" ***REMOVED***
		separator = opts.CommandSeparator
	***REMOVED***
	basename := strings.Replace(cmd.CommandPath(), " ", separator, -1)
	filename := filepath.Join(opts.Path, basename+"."+section)
	f, err := os.Create(filename)
	if err != nil ***REMOVED***
		return err
	***REMOVED***
	defer f.Close()

	headerCopy := *header
	return GenMan(cmd, &headerCopy, f)
***REMOVED***

// GenManTreeOptions is the options for generating the man pages.
// Used only in GenManTreeFromOpts.
type GenManTreeOptions struct ***REMOVED***
	Header           *GenManHeader
	Path             string
	CommandSeparator string
***REMOVED***

// GenManHeader is a lot like the .TH header at the start of man pages. These
// include the title, section, date, source, and manual. We will use the
// current time if Date if unset and will use "Auto generated by spf13/cobra"
// if the Source is unset.
type GenManHeader struct ***REMOVED***
	Title   string
	Section string
	Date    *time.Time
	date    string
	Source  string
	Manual  string
***REMOVED***

// GenMan will generate a man page for the given command and write it to
// w. The header argument may be nil, however obviously w may not.
func GenMan(cmd *cobra.Command, header *GenManHeader, w io.Writer) error ***REMOVED***
	if header == nil ***REMOVED***
		header = &GenManHeader***REMOVED******REMOVED***
	***REMOVED***
	fillHeader(header, cmd.CommandPath())

	b := genMan(cmd, header)
	_, err := w.Write(md2man.Render(b))
	return err
***REMOVED***

func fillHeader(header *GenManHeader, name string) ***REMOVED***
	if header.Title == "" ***REMOVED***
		header.Title = strings.ToUpper(strings.Replace(name, " ", "\\-", -1))
	***REMOVED***
	if header.Section == "" ***REMOVED***
		header.Section = "1"
	***REMOVED***
	if header.Date == nil ***REMOVED***
		now := time.Now()
		header.Date = &now
	***REMOVED***
	header.date = (*header.Date).Format("Jan 2006")
	if header.Source == "" ***REMOVED***
		header.Source = "Auto generated by spf13/cobra"
	***REMOVED***
***REMOVED***

func manPreamble(buf *bytes.Buffer, header *GenManHeader, cmd *cobra.Command, dashedName string) ***REMOVED***
	description := cmd.Long
	if len(description) == 0 ***REMOVED***
		description = cmd.Short
	***REMOVED***

	buf.WriteString(fmt.Sprintf(`%% %s(%s)%s
%% %s
%% %s
# NAME
`, header.Title, header.Section, header.date, header.Source, header.Manual))
	buf.WriteString(fmt.Sprintf("%s \\- %s\n\n", dashedName, cmd.Short))
	buf.WriteString("# SYNOPSIS\n")
	buf.WriteString(fmt.Sprintf("**%s**\n\n", cmd.UseLine()))
	buf.WriteString("# DESCRIPTION\n")
	buf.WriteString(description + "\n\n")
***REMOVED***

func manPrintFlags(buf *bytes.Buffer, flags *pflag.FlagSet) ***REMOVED***
	flags.VisitAll(func(flag *pflag.Flag) ***REMOVED***
		if len(flag.Deprecated) > 0 || flag.Hidden ***REMOVED***
			return
		***REMOVED***
		format := ""
		if len(flag.Shorthand) > 0 && len(flag.ShorthandDeprecated) == 0 ***REMOVED***
			format = fmt.Sprintf("**-%s**, **--%s**", flag.Shorthand, flag.Name)
		***REMOVED*** else ***REMOVED***
			format = fmt.Sprintf("**--%s**", flag.Name)
		***REMOVED***
		if len(flag.NoOptDefVal) > 0 ***REMOVED***
			format += "["
		***REMOVED***
		if flag.Value.Type() == "string" ***REMOVED***
			// put quotes on the value
			format += "=%q"
		***REMOVED*** else ***REMOVED***
			format += "=%s"
		***REMOVED***
		if len(flag.NoOptDefVal) > 0 ***REMOVED***
			format += "]"
		***REMOVED***
		format += "\n\t%s\n\n"
		buf.WriteString(fmt.Sprintf(format, flag.DefValue, flag.Usage))
	***REMOVED***)
***REMOVED***

func manPrintOptions(buf *bytes.Buffer, command *cobra.Command) ***REMOVED***
	flags := command.NonInheritedFlags()
	if flags.HasAvailableFlags() ***REMOVED***
		buf.WriteString("# OPTIONS\n")
		manPrintFlags(buf, flags)
		buf.WriteString("\n")
	***REMOVED***
	flags = command.InheritedFlags()
	if flags.HasAvailableFlags() ***REMOVED***
		buf.WriteString("# OPTIONS INHERITED FROM PARENT COMMANDS\n")
		manPrintFlags(buf, flags)
		buf.WriteString("\n")
	***REMOVED***
***REMOVED***

func genMan(cmd *cobra.Command, header *GenManHeader) []byte ***REMOVED***
	cmd.InitDefaultHelpCmd()
	cmd.InitDefaultHelpFlag()

	// something like `rootcmd-subcmd1-subcmd2`
	dashCommandName := strings.Replace(cmd.CommandPath(), " ", "-", -1)

	buf := new(bytes.Buffer)

	manPreamble(buf, header, cmd, dashCommandName)
	manPrintOptions(buf, cmd)
	if len(cmd.Example) > 0 ***REMOVED***
		buf.WriteString("# EXAMPLE\n")
		buf.WriteString(fmt.Sprintf("```\n%s\n```\n", cmd.Example))
	***REMOVED***
	if hasSeeAlso(cmd) ***REMOVED***
		buf.WriteString("# SEE ALSO\n")
		seealsos := make([]string, 0)
		if cmd.HasParent() ***REMOVED***
			parentPath := cmd.Parent().CommandPath()
			dashParentPath := strings.Replace(parentPath, " ", "-", -1)
			seealso := fmt.Sprintf("**%s(%s)**", dashParentPath, header.Section)
			seealsos = append(seealsos, seealso)
			cmd.VisitParents(func(c *cobra.Command) ***REMOVED***
				if c.DisableAutoGenTag ***REMOVED***
					cmd.DisableAutoGenTag = c.DisableAutoGenTag
				***REMOVED***
			***REMOVED***)
		***REMOVED***
		children := cmd.Commands()
		sort.Sort(byName(children))
		for _, c := range children ***REMOVED***
			if !c.IsAvailableCommand() || c.IsAdditionalHelpTopicCommand() ***REMOVED***
				continue
			***REMOVED***
			seealso := fmt.Sprintf("**%s-%s(%s)**", dashCommandName, c.Name(), header.Section)
			seealsos = append(seealsos, seealso)
		***REMOVED***
		buf.WriteString(strings.Join(seealsos, ", ") + "\n")
	***REMOVED***
	if !cmd.DisableAutoGenTag ***REMOVED***
		buf.WriteString(fmt.Sprintf("# HISTORY\n%s Auto generated by spf13/cobra\n", header.Date.Format("2-Jan-2006")))
	***REMOVED***
	return buf.Bytes()
***REMOVED***
