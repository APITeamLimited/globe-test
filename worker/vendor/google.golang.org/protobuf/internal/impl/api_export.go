// Copyright 2018 The Go Authors. All rights reserved.
// Use of this source code is governed by a BSD-style
// license that can be found in the LICENSE file.

package impl

import (
	"fmt"
	"reflect"
	"strconv"

	"google.golang.org/protobuf/encoding/prototext"
	"google.golang.org/protobuf/internal/errors"
	"google.golang.org/protobuf/proto"
	"google.golang.org/protobuf/reflect/protoreflect"
	"google.golang.org/protobuf/runtime/protoiface"
)

// Export is a zero-length named type that exists only to export a set of
// functions that we do not want to appear in godoc.
type Export struct***REMOVED******REMOVED***

// NewError formats a string according to the format specifier and arguments and
// returns an error that has a "proto" prefix.
func (Export) NewError(f string, x ...interface***REMOVED******REMOVED***) error ***REMOVED***
	return errors.New(f, x...)
***REMOVED***

// enum is any enum type generated by protoc-gen-go
// and must be a named int32 type.
type enum = interface***REMOVED******REMOVED***

// EnumOf returns the protoreflect.Enum interface over e.
// It returns nil if e is nil.
func (Export) EnumOf(e enum) protoreflect.Enum ***REMOVED***
	switch e := e.(type) ***REMOVED***
	case nil:
		return nil
	case protoreflect.Enum:
		return e
	default:
		return legacyWrapEnum(reflect.ValueOf(e))
	***REMOVED***
***REMOVED***

// EnumDescriptorOf returns the protoreflect.EnumDescriptor for e.
// It returns nil if e is nil.
func (Export) EnumDescriptorOf(e enum) protoreflect.EnumDescriptor ***REMOVED***
	switch e := e.(type) ***REMOVED***
	case nil:
		return nil
	case protoreflect.Enum:
		return e.Descriptor()
	default:
		return LegacyLoadEnumDesc(reflect.TypeOf(e))
	***REMOVED***
***REMOVED***

// EnumTypeOf returns the protoreflect.EnumType for e.
// It returns nil if e is nil.
func (Export) EnumTypeOf(e enum) protoreflect.EnumType ***REMOVED***
	switch e := e.(type) ***REMOVED***
	case nil:
		return nil
	case protoreflect.Enum:
		return e.Type()
	default:
		return legacyLoadEnumType(reflect.TypeOf(e))
	***REMOVED***
***REMOVED***

// EnumStringOf returns the enum value as a string, either as the name if
// the number is resolvable, or the number formatted as a string.
func (Export) EnumStringOf(ed protoreflect.EnumDescriptor, n protoreflect.EnumNumber) string ***REMOVED***
	ev := ed.Values().ByNumber(n)
	if ev != nil ***REMOVED***
		return string(ev.Name())
	***REMOVED***
	return strconv.Itoa(int(n))
***REMOVED***

// message is any message type generated by protoc-gen-go
// and must be a pointer to a named struct type.
type message = interface***REMOVED******REMOVED***

// legacyMessageWrapper wraps a v2 message as a v1 message.
type legacyMessageWrapper struct***REMOVED*** m protoreflect.ProtoMessage ***REMOVED***

func (m legacyMessageWrapper) Reset()         ***REMOVED*** proto.Reset(m.m) ***REMOVED***
func (m legacyMessageWrapper) String() string ***REMOVED*** return Export***REMOVED******REMOVED***.MessageStringOf(m.m) ***REMOVED***
func (m legacyMessageWrapper) ProtoMessage()  ***REMOVED******REMOVED***

// ProtoMessageV1Of converts either a v1 or v2 message to a v1 message.
// It returns nil if m is nil.
func (Export) ProtoMessageV1Of(m message) protoiface.MessageV1 ***REMOVED***
	switch mv := m.(type) ***REMOVED***
	case nil:
		return nil
	case protoiface.MessageV1:
		return mv
	case unwrapper:
		return Export***REMOVED******REMOVED***.ProtoMessageV1Of(mv.protoUnwrap())
	case protoreflect.ProtoMessage:
		return legacyMessageWrapper***REMOVED***mv***REMOVED***
	default:
		panic(fmt.Sprintf("message %T is neither a v1 or v2 Message", m))
	***REMOVED***
***REMOVED***

func (Export) protoMessageV2Of(m message) protoreflect.ProtoMessage ***REMOVED***
	switch mv := m.(type) ***REMOVED***
	case nil:
		return nil
	case protoreflect.ProtoMessage:
		return mv
	case legacyMessageWrapper:
		return mv.m
	case protoiface.MessageV1:
		return nil
	default:
		panic(fmt.Sprintf("message %T is neither a v1 or v2 Message", m))
	***REMOVED***
***REMOVED***

// ProtoMessageV2Of converts either a v1 or v2 message to a v2 message.
// It returns nil if m is nil.
func (Export) ProtoMessageV2Of(m message) protoreflect.ProtoMessage ***REMOVED***
	if m == nil ***REMOVED***
		return nil
	***REMOVED***
	if mv := (Export***REMOVED******REMOVED***).protoMessageV2Of(m); mv != nil ***REMOVED***
		return mv
	***REMOVED***
	return legacyWrapMessage(reflect.ValueOf(m)).Interface()
***REMOVED***

// MessageOf returns the protoreflect.Message interface over m.
// It returns nil if m is nil.
func (Export) MessageOf(m message) protoreflect.Message ***REMOVED***
	if m == nil ***REMOVED***
		return nil
	***REMOVED***
	if mv := (Export***REMOVED******REMOVED***).protoMessageV2Of(m); mv != nil ***REMOVED***
		return mv.ProtoReflect()
	***REMOVED***
	return legacyWrapMessage(reflect.ValueOf(m))
***REMOVED***

// MessageDescriptorOf returns the protoreflect.MessageDescriptor for m.
// It returns nil if m is nil.
func (Export) MessageDescriptorOf(m message) protoreflect.MessageDescriptor ***REMOVED***
	if m == nil ***REMOVED***
		return nil
	***REMOVED***
	if mv := (Export***REMOVED******REMOVED***).protoMessageV2Of(m); mv != nil ***REMOVED***
		return mv.ProtoReflect().Descriptor()
	***REMOVED***
	return LegacyLoadMessageDesc(reflect.TypeOf(m))
***REMOVED***

// MessageTypeOf returns the protoreflect.MessageType for m.
// It returns nil if m is nil.
func (Export) MessageTypeOf(m message) protoreflect.MessageType ***REMOVED***
	if m == nil ***REMOVED***
		return nil
	***REMOVED***
	if mv := (Export***REMOVED******REMOVED***).protoMessageV2Of(m); mv != nil ***REMOVED***
		return mv.ProtoReflect().Type()
	***REMOVED***
	return legacyLoadMessageType(reflect.TypeOf(m), "")
***REMOVED***

// MessageStringOf returns the message value as a string,
// which is the message serialized in the protobuf text format.
func (Export) MessageStringOf(m protoreflect.ProtoMessage) string ***REMOVED***
	return prototext.MarshalOptions***REMOVED***Multiline: false***REMOVED***.Format(m)
***REMOVED***
